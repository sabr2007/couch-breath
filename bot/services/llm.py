"""
–†–∞–±–æ—Ç–∞ —Å OpenAI API ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –î–ó
–í–µ—Ä—Å–∏—è 2.0: —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞–º–∏ —É—Ä–æ–∫–æ–≤ –∏ –ø—Ä–æ—Ñ–∏–ª–µ–º –ò–ª—å–¥–∞—Ä–∞
"""

import json
import random
from openai import AsyncOpenAI

from bot.config import config
from bot.services.lesson_contexts import (
    ILDAR_PROFILE,
    LESSON_CONTEXTS,
    get_lesson_context,
    has_detailed_context
)


# –ö–ª–∏–µ–Ω—Ç OpenAI
client = AsyncOpenAI(api_key=config.OPENAI_API_KEY)


# ============================================
# –°–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã
# ============================================

# –ü—Ä–æ–º–ø—Ç –¥–ª—è —É—Ä–æ–∫–æ–≤ –° –¥–µ—Ç–∞–ª—å–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
DETAILED_SYSTEM_PROMPT = """
{ildar_profile}

---

–ö–û–ù–¢–ï–ö–°–¢ –£–†–û–ö–ê {lesson_number}: {lesson_title}

–ó–ê–î–ê–ù–ò–ï:
{homework_task}

–ö–õ–Æ–ß–ï–í–´–ï –ö–û–ù–¶–ï–ü–¶–ò–ò, –∫–æ—Ç–æ—Ä—ã–µ —Å—Ç—É–¥–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –ø–æ–Ω—è—Ç—å:
{key_concepts}

–ù–ê –ß–¢–û –û–ë–†–ê–©–ê–¢–¨ –í–ù–ò–ú–ê–ù–ò–ï (–ø—Ä–∏–∑–Ω–∞–∫–∏ —Ö–æ—Ä–æ—à–µ–≥–æ –æ—Ç–≤–µ—Ç–∞):
{check_for}

–ö–†–ê–°–ù–´–ï –§–õ–ê–ì–ò (—Ç–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏):
{red_flags}

---

–®–ö–ê–õ–ê –û–¶–ï–ù–ö–ò:

‚ùå –ù–ï –ü–†–ò–ù–Ø–¢–û (verdict: REVISE):
{reject_criteria}

‚ö†Ô∏è –ß–ê–°–¢–ò–ß–ù–û (verdict: REVISE, –Ω–æ –º—è–≥—á–µ):
{partial_criteria}

‚úÖ –ü–†–ò–ù–Ø–¢–û (verdict: ACCEPT):
{accept_criteria}

‚≠ê –û–¢–õ–ò–ß–ù–û (verdict: ACCEPT —Å –æ—Å–æ–±–æ–π –ø–æ—Ö–≤–∞–ª–æ–π):
{excellent_criteria}

---

–ê–õ–ì–û–†–ò–¢–ú:

1. –ü–†–û–í–ï–†–ö–ê –ù–ê –ê–î–ï–ö–í–ê–¢–ù–û–°–¢–¨:
   - –°–ø–∞–º, –Ω–∞–±–æ—Ä –±—É–∫–≤, –æ—Ç–ø–∏—Å–∫–∞ (¬´–æ–∫¬ª, ¬´—Å–¥–µ–ª–∞–ª¬ª, ¬´.¬ª) ‚Üí REVISE
   - –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç (< 50 —Å–∏–º–≤–æ–ª–æ–≤ –æ—Å–º—ã—Å–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞) ‚Üí REVISE

2. –ü–†–û–í–ï–†–ö–ê –ü–û –®–ö–ê–õ–ï:
   - –û–ø—Ä–µ–¥–µ–ª–∏, –∫ –∫–∞–∫–æ–º—É —É—Ä–æ–≤–Ω—é –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –æ—Ç–≤–µ—Ç
   - –ò—Å–ø–æ–ª—å–∑—É–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —à–∞–±–ª–æ–Ω —Ñ–∏–¥–±—ç–∫–∞ –∫–∞–∫ –æ—Å–Ω–æ–≤—É
   - –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä—É–π: —É–ø–æ–º—è–Ω–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –¥–µ—Ç–∞–ª—å –∏–∑ –æ—Ç–≤–µ—Ç–∞ —Å—Ç—É–¥–µ–Ω—Ç–∞

3. –ì–ï–ù–ï–†–ê–¶–ò–Ø –û–¢–í–ï–¢–ê:
   - –ì–æ–≤–æ—Ä–∏ –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞ –∫–∞–∫ –ò–ª—å–¥–∞—Ä
   - –°—Ç—Ä—É–∫—Ç—É—Ä–∞: –ø–æ–¥–¥–µ—Ä–∂–∫–∞ ‚Üí —É—Ç–æ—á–Ω–µ–Ω–∏–µ ‚Üí –≤–æ–ø—Ä–æ—Å (–µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ)
   - 2-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
   - –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å–ª–æ–≤–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ "–ù–ò–ö–û–ì–î–ê –ù–ï –ì–û–í–û–†–ò–®–¨"

–§–û–†–ú–ê–¢ –í–´–í–û–î–ê (—Å—Ç—Ä–æ–≥–æ JSON):
{{
  "verdict": "ACCEPT" –∏–ª–∏ "REVISE",
  "level": "reject" / "partial" / "accept" / "excellent",
  "message": "–¢–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∏–¥–±—ç–∫"
}}
"""


# –ü—Ä–æ–º–ø—Ç –¥–ª—è —É—Ä–æ–∫–æ–≤ –ë–ï–ó –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–±–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
BASIC_SYSTEM_PROMPT = """
{ildar_profile}

---

–ö–û–ù–¢–ï–ö–°–¢ –£–†–û–ö–ê {lesson_number}: {lesson_title}

–ó–ê–î–ê–ù–ò–ï:
{homework_task}

---

–£ —Ç–µ–±—è –ø–æ–∫–∞ –Ω–µ—Ç –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è —ç—Ç–æ–≥–æ —É—Ä–æ–∫–∞.
–ü—Ä–æ–≤–µ—Ä—è–π –æ—Ç–≤–µ—Ç –ø–æ –û–ë–©–ò–ú –∫—Ä–∏—Ç–µ—Ä–∏—è–º:

1. –ü–†–û–í–ï–†–ö–ê –ù–ê –ê–î–ï–ö–í–ê–¢–ù–û–°–¢–¨:
   - –°–ø–∞–º, –Ω–∞–±–æ—Ä –±—É–∫–≤, –æ—Ç–ø–∏—Å–∫–∞ ‚Üí REVISE
   - –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç (< 50 —Å–∏–º–≤–æ–ª–æ–≤) ‚Üí REVISE
   - –û—Ç–≤–µ—Ç –Ω–µ –ø–æ —Ç–µ–º–µ –∑–∞–¥–∞–Ω–∏—è ‚Üí REVISE

2. –ü–†–û–í–ï–†–ö–ê –ù–ê –ì–õ–£–ë–ò–ù–£:
   - –ï—Å—Ç—å –ª–∏ –ª–∏—á–Ω–∞—è —Ä–µ—Ñ–ª–µ–∫—Å–∏—è –∏–ª–∏ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –æ–ø—ã—Ç–∞?
   - –ï—Å—Ç—å –ª–∏ –ø–æ–ø—ã—Ç–∫–∞ –æ—Å–º—ã—Å–ª–∏—Ç—å, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Å–∫–∞–∑–∞—Ç—å?
   - –ß—É–≤—Å—Ç–≤—É–µ—Ç—Å—è –ª–∏ –ø–æ–∑–∏—Ü–∏—è –∞–≤—Ç–æ—Ä–∞?

3. –ü–†–ò–ù–Ø–¢–ò–ï –†–ï–®–ï–ù–ò–Ø:
   - –ï—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—å –∫–∞–∫–∞—è-—Ç–æ –æ—Å–º—ã—Å–ª–µ–Ω–Ω–∞—è –º—ã—Å–ª—å –ø–æ —Ç–µ–º–µ ‚Üí ACCEPT
   - –ï—Å–ª–∏ —Ñ–æ—Ä–º–∞–ª—å–Ω–∞—è –æ—Ç–ø–∏—Å–∫–∞ –±–µ–∑ –≥–ª—É–±–∏–Ω—ã ‚Üí REVISE (–º—è–≥–∫–æ –ø–æ–ø—Ä–æ—Å–∏ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å)

–ì–ï–ù–ï–†–ê–¶–ò–Ø –û–¢–í–ï–¢–ê:
- –ì–æ–≤–æ—Ä–∏ –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞ –∫–∞–∫ –ò–ª—å–¥–∞—Ä
- –ü–æ—Ö–≤–∞–ª–∏ –∑–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –¥–µ—Ç–∞–ª—å –∏–∑ –æ—Ç–≤–µ—Ç–∞
- –ï—Å–ª–∏ REVISE ‚Äî –º—è–≥–∫–æ –Ω–∞–ø—Ä–∞–≤—å, –Ω–µ –∫—Ä–∏—Ç–∏–∫—É–π
- 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è

–§–û–†–ú–ê–¢ –í–´–í–û–î–ê (—Å—Ç—Ä–æ–≥–æ JSON):
{{
  "verdict": "ACCEPT" –∏–ª–∏ "REVISE",
  "message": "–¢–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∏–¥–±—ç–∫"
}}
"""


# ============================================
# Fallback –æ—Ç–≤–µ—Ç—ã
# ============================================

FALLBACK_ACCEPT = [
    "–•–æ—Ä–æ—à–∞—è —Ä–∞–±–æ—Ç–∞! –í–∏–¥–Ω–æ, —á—Ç–æ —Ç—ã –¥—É–º–∞–ª –Ω–∞–¥ –æ—Ç–≤–µ—Ç–æ–º. üëç",
    "–ü—Ä–∏–Ω—è—Ç–æ! –ß—É–≤—Å—Ç–≤—É–µ—Ç—Å—è —Ç–≤–æ—ë –≤–∫–ª—é—á–µ–Ω–∏–µ –≤ —Ç–µ–º—É.",
    "–ó–¥–µ—Å—å –µ—Å—Ç—å –º—ã—Å–ª—å ‚Äî –¥–≤–∏–≥–∞–µ–º—Å—è –¥–∞–ª—å—à–µ. ü§ç"
]

FALLBACK_REVISE = [
    "–ü–æ–ø—Ä–æ–±—É–π —Ä–∞—Å–∫—Ä—ã—Ç—å –º—ã—Å–ª—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ ‚Äî –ø–æ–∫–∞ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –≥–ª—É–±–∏–Ω—ã.",
    "–Ø –≤–∏–∂—É –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, –Ω–æ —Ö–æ—Ç–µ–ª–æ—Å—å –±—ã –±–æ–ª—å—à–µ —Ç–≤–æ–µ–≥–æ –ª–∏—á–Ω–æ–≥–æ –≤–∑–≥–ª—è–¥–∞. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑?",
    "–î–∞–≤–∞–π –∑–∞–º–µ–¥–ª–∏–º—Å—è. –ü–æ–ø—Ä–æ–±—É–π –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–µ —Ñ–æ—Ä–º–∞–ª—å–Ω–æ, –∞ –∏–∑ —Å–≤–æ–µ–≥–æ –æ–ø—ã—Ç–∞."
]

FILE_VIDEO_RESPONSES = [
    "–û—Ç–ª–∏—á–Ω–æ! üé¨ –ü–æ–ª—É—á–∏–ª —Ç–≤–æ—é —Ä–∞–±–æ—Ç—É. –í–∏–¥–Ω–æ, —á—Ç–æ —Ç—ã –≤–ª–æ–∂–∏–ª—Å—è ‚Äî —Ç–∞–∫ –¥–µ—Ä–∂–∞—Ç—å!",
    "–ü—Ä–∏–Ω—è—Ç–æ! üëç –°–ø–∞—Å–∏–±–æ –∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ. –î–≤–∏–≥–∞–µ–º—Å—è –¥–∞–ª—å—à–µ.",
    "–ü–æ–ª—É—á–∏–ª! –¶–µ–Ω—é, —á—Ç–æ —Ç—ã –Ω–µ –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø–∏—Å–∞–ª—Å—è, –∞ —Å–¥–µ–ª–∞–ª. ü§ç",
]


# ============================================
# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏
# ============================================

async def check_homework_with_ai(
    lesson_number: int,
    lesson_topic: str,
    homework_task: str,
    user_answer: str
) -> dict:
    """
    –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –î–ó —á–µ—Ä–µ–∑ OpenAI.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ –±–∞–∑–æ–≤—É—é –ø—Ä–æ–≤–µ—Ä–∫—É.
    
    Returns:
        {"verdict": "ACCEPT" | "REVISE", "message": "..."}
    """
    
    context = get_lesson_context(lesson_number)
    use_detailed = has_detailed_context(lesson_number)
    
    try:
        if use_detailed:
            # –§–æ—Ä–º–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç
            system_prompt = DETAILED_SYSTEM_PROMPT.format(
                ildar_profile=ILDAR_PROFILE,
                lesson_number=lesson_number,
                lesson_title=context.get("title", lesson_topic),
                homework_task=homework_task,
                key_concepts="\n".join(f"‚Ä¢ {c}" for c in context.get("key_concepts", [])),
                check_for="\n".join(f"‚Ä¢ {c}" for c in context.get("check_for", [])),
                red_flags="\n".join(f"‚Ä¢ {c}" for c in context.get("red_flags", [])),
                reject_criteria=context.get("grading_scale", {}).get("reject", {}).get("criteria", ""),
                partial_criteria=context.get("grading_scale", {}).get("partial", {}).get("criteria", ""),
                accept_criteria=context.get("grading_scale", {}).get("accept", {}).get("criteria", ""),
                excellent_criteria=context.get("grading_scale", {}).get("excellent", {}).get("criteria", ""),
            )
        else:
            # –ë–∞–∑–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç
            system_prompt = BASIC_SYSTEM_PROMPT.format(
                ildar_profile=ILDAR_PROFILE,
                lesson_number=lesson_number,
                lesson_title=context.get("title", lesson_topic),
                homework_task=homework_task,
            )
        
        response = await client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": f"–û—Ç–≤–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç–∞:\n\n{user_answer}"}
            ],
            temperature=0.7,
            max_tokens=400,
            timeout=config.LLM_TIMEOUT,
            response_format={"type": "json_object"}
        )
        
        result = json.loads(response.choices[0].message.content)
        
        # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –æ—Ç–≤–µ—Ç
        return {
            "verdict": result.get("verdict", "ACCEPT"),
            "message": result.get("message", random.choice(FALLBACK_ACCEPT))
        }
        
    except Exception as e:
        # Fallback –ø—Ä–∏ –æ—à–∏–±–∫–µ
        if len(user_answer) >= config.MIN_ANSWER_LENGTH:
            return {
                "verdict": "ACCEPT",
                "message": random.choice(FALLBACK_ACCEPT)
            }
        else:
            return {
                "verdict": "REVISE",
                "message": random.choice(FALLBACK_REVISE)
            }


def get_file_video_response() -> dict:
    """–û—Ç–≤–µ—Ç –¥–ª—è —Ñ–∞–π–ª–æ–≤/–≤–∏–¥–µ–æ (–±–µ–∑ AI –ø—Ä–æ–≤–µ—Ä–∫–∏)"""
    return {
        "verdict": "ACCEPT",
        "message": random.choice(FILE_VIDEO_RESPONSES)
    }