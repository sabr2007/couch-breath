"""
–†–∞–±–æ—Ç–∞ —Å OpenAI API ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –î–ó
"""

import json
import random
from openai import AsyncOpenAI

from bot.config import config


# –ö–ª–∏–µ–Ω—Ç OpenAI
client = AsyncOpenAI(api_key=config.OPENAI_API_KEY)


# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –î–ó
SYSTEM_PROMPT = """
–¢—ã ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π –∏ –º—É–¥—Ä—ã–π –º–µ–Ω—Ç–æ—Ä –∫—É—Ä—Å–∞ "–î—ã—Ö–∞–Ω–∏–µ –¢—Ä–µ–Ω–µ—Ä–∞".
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç–∞ –∏ –¥–∞—Ç—å –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å.

–ê–õ–ì–û–†–ò–¢–ú:

1. –ü–†–û–í–ï–†–ö–ê –ù–ê –ê–î–ï–ö–í–ê–¢–ù–û–°–¢–¨:
   - –ï—Å–ª–∏ —ç—Ç–æ —Å–ø–∞–º, –Ω–∞–±–æ—Ä –±—É–∫–≤, –∏–ª–∏ –ø—É—Å—Ç–∞—è –æ—Ç–ø–∏—Å–∫–∞ (¬´–æ–∫¬ª, ¬´—Å–¥–µ–ª–∞–ª¬ª, ¬´.¬ª) ‚Üí –≤–µ—Ä–¥–∏–∫—Ç REVISE
   - –ï—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—å –∫–∞–∫–∞—è-—Ç–æ –æ—Å–º—ã—Å–ª–µ–Ω–Ω–∞—è –º—ã—Å–ª—å –ø–æ —Ç–µ–º–µ ‚Üí –≤–µ—Ä–¥–∏–∫—Ç ACCEPT

2. –ì–ï–ù–ï–†–ê–¶–ò–Ø –û–¢–í–ï–¢–ê:
   
   –ï—Å–ª–∏ ACCEPT:
   - –ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–∏–π (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) –æ–±–æ–¥—Ä—è—é—â–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
   - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø–æ—Ö–≤–∞–ª–∏ –∑–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –¥–µ—Ç–∞–ª—å –∏–∑ –æ—Ç–≤–µ—Ç–∞
   - –ò—Å–ø–æ–ª—å–∑—É–π —Ç–µ–ø–ª—ã–π, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–æ–Ω
   - –≠–º–æ–¥–∑–∏: —É–º–µ—Ä–µ–Ω–Ω–æ (üëç, üî•, ‚ú®, üí™)
   - –ù–ï —É—á–∏ –∏ –ù–ï –∫—Ä–∏—Ç–∏–∫—É–π ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ–¥–¥–µ—Ä–∂–∫–∞
   
   –ï—Å–ª–∏ REVISE:
   - –í–µ–∂–ª–∏–≤–æ –ø–æ–ø—Ä–æ—Å–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç
   - –û–±—ä—è—Å–Ω–∏, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω–µ —Ç–∞–∫ (—Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ / –Ω–µ –ø–æ —Ç–µ–º–µ)
   - –ü–æ–¥–±–æ–¥—Ä–∏ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –µ—â—ë —Ä–∞–∑

–§–û–†–ú–ê–¢ –í–´–í–û–î–ê (—Å—Ç—Ä–æ–≥–æ JSON):
{
  "verdict": "ACCEPT" –∏–ª–∏ "REVISE",
  "message": "–¢–≤–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∑–¥–µ—Å—å"
}
"""


# Fallback –æ—Ç–≤–µ—Ç—ã –ø—Ä–∏ —Å–±–æ–µ LLM
FALLBACK_MESSAGES = [
    "–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –û—Ç–≤–µ—Ç –ø—Ä–∏–Ω—è—Ç ‚úÖ",
    "–•–æ—Ä–æ—à–æ –ø–æ—Ä–∞–±–æ—Ç–∞–ª! –î–≤–∏–≥–∞–µ–º—Å—è –¥–∞–ª—å—à–µ üí™",
    "–ü—Ä–∏–Ω—è—Ç–æ! –¢—ã –º–æ–ª–æ–¥–µ—Ü ‚ú®"
]


# –û—Ç–≤–µ—Ç—ã –¥–ª—è —Ñ–∞–π–ª–æ–≤/–≤–∏–¥–µ–æ (–±–µ–∑ AI –ø—Ä–æ–≤–µ—Ä–∫–∏)
FILE_VIDEO_RESPONSES = [
    "–û—Ç–ª–∏—á–Ω–æ! üé¨ –¢–≤–æ—ë –¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ. –¢–∞–∫ –¥–µ—Ä–∂–∞—Ç—å!",
    "–°—É–ø–µ—Ä! ‚úÖ –ü–æ–ª—É—á–∏–ª —Ç–≤–æ—é —Ä–∞–±–æ—Ç—É. –ú–æ–ª–æ–¥–µ—Ü, —á—Ç–æ –≤—ã–ø–æ–ª–Ω–∏–ª!",
    "–ü—Ä–∏–Ω—è—Ç–æ! üí™ –í–∏–¥–Ω–æ, —á—Ç–æ —Ç—ã —Å—Ç–∞—Ä–∞–µ—à—å—Å—è. –ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ!",
    "–ö–ª–∞—Å—Å! üî• –î–æ–º–∞—à–∫–∞ –∑–∞—á—Ç–µ–Ω–∞. –î–≤–∏–≥–∞–µ–º—Å—è –¥–∞–ª—å—à–µ!",
    "–ü–æ–ª—É—á–∏–ª! ‚ú® –û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞. –¢—ã –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø—É—Ç–∏!",
]


async def check_homework_with_ai(
    lesson_number: int,
    lesson_topic: str,
    homework_task: str,
    user_answer: str
) -> dict:
    """
    –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –î–ó —á–µ—Ä–µ–∑ OpenAI.
    
    Returns:
        {"verdict": "ACCEPT" | "REVISE", "message": "..."}
    """
    try:
        response = await client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": SYSTEM_PROMPT},
                {"role": "user", "content": (
                    f"–£—Ä–æ–∫ {lesson_number}: {lesson_topic}\n"
                    f"–ó–∞–¥–∞–Ω–∏–µ: {homework_task}\n"
                    f"–û—Ç–≤–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç–∞: {user_answer}"
                )}
            ],
            temperature=0.7,
            max_tokens=300,
            timeout=config.LLM_TIMEOUT,
            response_format={"type": "json_object"}
        )
        
        result = json.loads(response.choices[0].message.content)
        return result
        
    except Exception as e:
        # Fallback: –∑–∞—Å—á–∏—Ç—ã–≤–∞–µ–º –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–π –¥–ª–∏–Ω—ã
        if len(user_answer) >= config.MIN_ANSWER_LENGTH:
            return {
                "verdict": "ACCEPT",
                "message": random.choice(FALLBACK_MESSAGES)
            }
        else:
            return {
                "verdict": "REVISE",
                "message": "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏ –æ—Ç–≤–µ—Ç –ø–æ–¥—Ä–æ–±–Ω–µ–µ"
            }


def get_file_video_response() -> dict:
    """–û—Ç–≤–µ—Ç –¥–ª—è —Ñ–∞–π–ª–æ–≤/–≤–∏–¥–µ–æ (–±–µ–∑ AI –ø—Ä–æ–≤–µ—Ä–∫–∏)"""
    return {
        "verdict": "ACCEPT",
        "message": random.choice(FILE_VIDEO_RESPONSES)
    }
